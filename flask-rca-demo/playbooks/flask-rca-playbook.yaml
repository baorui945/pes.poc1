triggers:
  - on_log:
      name: "flask-app-error-log"
      filters:
        namespace: "rca-demo"
        pod_name_prefix: "flask-rca-demo"
        log_level: ["error", "critical"]
      actions:
        - builtin_action: "log_enricher"
          params:
            named_captures:
              error_type: '"error_type":\s*"([^"]+)"'
              trace_id: '"trace_id":\s*"([^"]+)"'
              message: '"message":\s*"([^"]+)"'

        - builtin_action: "slack_sender"
          params:
            slack_channel: "#alerts-devops"
            message: |
              :rotating_light: **Flask RCA Demo Error Detected**
              - **Error Type**: {{ error_type }}
              - **Trace ID**: `{{ trace_id }}`
              - **Message**: {{ message }}
              - **Pod**: {{ pod_name }}
              - **Namespace**: {{ namespace }}

              ```json
              {{ log }}
              ```

        - builtin_action: "prometheus_query"
          params:
            prometheus_url: "http://prometheus-k8s.monitoring.svc:9090"
            queries:
              - name: "request_rate_5m"
                query: 'rate(http_requests_total{namespace="rca-demo", endpoint="process_order"}[5m])'
              - name: "error_rate_5m"
                query: 'rate(app_errors_total{namespace="rca-demo", error_type="{{ error_type }}"}[5m])'
            result_format: "table"

        - builtin_action: "krr_resource_recommendations"
          params:
            namespaces: ["rca-demo"]
            strategy: "balanced"

        - builtin_action: "add_to_evidence_file"
          params:
            filename: "rca_context.md"
            content: |
              ## Root Cause Analysis Context
              - **Error Type**: {{ error_type }}
              - **Trace ID**: {{ trace_id }}
              - **Log Snippet**:
                ```json
                {{ log }}
                ```
              - **Prometheus Metrics**:
                {{ prometheus_query_result }}
              - **KRR Recommendation**:
                {{ krr_recommendation }}

  - on_prometheus_alert:
      alert_name: "HighFlaskAppErrorRate"
      actions:
        - builtin_action: "slack_sender"
          params:
            slack_channel: "#alerts-devops"
            message: ":chart_with_downwards_trend: High error rate in flask-rca-demo! Check Robusta UI for details."

  - on_pod_crash_loop:
      filters:
        namespace: "rca-demo"
        labels:
          app.kubernetes.io/name: "flask-rca-demo"
      actions:
        - builtin_action: "pod_logs"
          params:
            previous: true
        - builtin_action: "slack_sender"
          params:
            slack_channel: "#alerts-devops"
            message: |
              :skull: Pod `{{ pod_name }}` is in CrashLoopBackOff!
              Last logs (previous container):
              ```
              {{ pod_logs }}
              ```